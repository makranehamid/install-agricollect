<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgriCollect Chefchaouen</title>
    
    <script src="./lib/react.production.min.js"></script>
    <script src="./lib/react-dom.production.min.js"></script>
    <script src="./lib/babel.min.js"></script>
    <script src="./lib/tailwindcss.js"></script>
    
    <script>
        // Votre configuration Tailwind
        tailwind.config = {
            content: [
                './index.html' 
            ],
            theme: {
                extend: {
                    colors: {
                        agri: { 
                            50: '#f2fcf5', 100: '#e1f8e8', 200: '#c3ecd0', 300: '#94dab0', 400: '#5cbf8a', 500: '#38a370', 600: '#288258', 700: '#226848', 800: '#1d523b', 900: '#184432' 
                        }
                    },
                    animation: {
                        'in': 'fadeIn 0.3s ease-out forwards',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        input, textarea, select { font-size: 16px !important; }
    </style>
</head>
<body class="bg-agri-50 text-gray-900">
    <header class="bg-agri-600 text-white p-4 shadow-lg sticky top-0 z-10">
        <h1 class="text-xl font-bold">AgriCollect Chefchaouen (v1)</h1>
        
        <!-- 2. VOTRE SIGNATURE, juste en dessous du titre -->
        <p class="text-xs opacity-80 mt-1">D√©velopp√© par MAKRANE Hamid</p>
    </header>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS (Identique) ---
        const Icon = ({ path, className, size = 24, color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={path} />
            </svg>
        );

        const ICONS = {
            User: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8",
            Sprout: "M7 20h10 M10 20c5.5-2.5.8-6.4 3-10 1.7-2.8 5-4 5-4V4h-1v2s-4.2.4-6 6c-1.8-1.5-3.3-3.5-6-6v4c2.8 2.5 4.2 4.6 6 6 .8 2.3-2.5 6.2-7 8",
            Camera: "M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6",
            Send: "m22 2-7 20-4-9-9-4Z M22 2 11 13",
            Database: "M3 5V19A9 3 0 0 0 21 19V5 M3 5A9 9 0 0 1 21 5 M3 12A9 9 0 0 0 21 12",
            Settings: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6",
            Wifi: "M5 12.55a11 11 0 0 1 14.08 0 M1.42 9a16 16 0 0 1 21.16 0 M8.53 16.11a6 6 0 0 1 6.95 0 M12 20h.01",
            WifiOff: "M2 2l20 20 M8.5 16a6 6 0 0 1 6 4.6 M5 12.5a11 11 0 0 1 8.8-3.08 M1.42 9a16 16 0 0 1 4.7-2.88",
            MapPin: "M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z M12 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6",
            Navigation: "m3 11 19-9-9 19-2-8-8-2Z",
            CheckCircle2: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M9 12l2 2 4-4",
            AlertTriangle: "m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z M12 9v4 M12 17h.01",
            RefreshCw: "M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8 M21 3v5h-5 M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16 M3 21v-5h5",
            X: "M18 6 6 18 M6 6 18 18",
            Flower2: "M12 5a3 3 0 1 1 3 3m-3-3a3 3 0 1 0-3 3m3-3v1m0 0a3 3 0 1 0 3 3m-3-3a3 3 0 1 1-3 3m3-3v2m0 0a3 3 0 1 0 3 3m-3-3a3 3 0 1 1-3 3m3-3v3.4c1.8-1 4.3-.9 5.5.9 1.4 2 .4 5-1.5 5.5C12 22 12 22 12 22s0 0-3-1.6c-1.9-.5-2.9-3-1.5-5.5 1.2-1.8 3.7-1.9 5.5-.9",
            Wheat: "M2 22 16 8 M3.06 14.5a3 3 0 1 1 4.24-4.25L9 8.5 M10.5 17.5a3 3 0 1 1 4.24-4.25L12.5 11.5 M6.5 11.5a3 3 0 1 1 4.24-4.25L8.5 5.5 M14.5 21.5a3 3 0 1 1 4.24-4.25L16.5 15.5 M10.5 8.5a3 3 0 1 1 4.24-4.25L12.5 2.5",
            Leaf: "M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"
        };
        
        const UserIcon = (props) => <Icon path={ICONS.User} {...props} />;
        const SproutIcon = (props) => <Icon path={ICONS.Sprout} {...props} />;
        const CameraIcon = (props) => <Icon path={ICONS.Camera} {...props} />;
        const SendIcon = (props) => <Icon path={ICONS.Send} {...props} />;
        const DatabaseIcon = (props) => <Icon path={ICONS.Database} {...props} />;
        const SettingsIcon = (props) => <Icon path={ICONS.Settings} {...props} />;
        const WifiIcon = (props) => <Icon path={ICONS.Wifi} {...props} />;
        const WifiOffIcon = (props) => <Icon path={ICONS.WifiOff} {...props} />;
        const MapPinIcon = (props) => <Icon path={ICONS.MapPin} {...props} />;
        const NavigationIcon = (props) => <Icon path={ICONS.Navigation} {...props} />;
        const CheckCircle2Icon = (props) => <Icon path={ICONS.CheckCircle2} {...props} />;
        const AlertTriangleIcon = (props) => <Icon path={ICONS.AlertTriangle} {...props} />;
        const RefreshCwIcon = (props) => <Icon path={ICONS.RefreshCw} {...props} />;
        const XIcon = (props) => <Icon path={ICONS.X} {...props} />;
        const Flower2Icon = (props) => <Icon path={ICONS.Flower2} {...props} />;
        const WheatIcon = (props) => <Icon path={ICONS.Wheat} {...props} />;
        const LeafIcon = (props) => <Icon path={ICONS.Leaf} {...props} />;

        // --- CONFIG ---
        const NEW_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKqb5_sUmBOJYW5SNJypywFQ9_Ij4hxtm7jBTwRULX1jrpf7jpeX-j1ndjgYT8137xKA/exec"; // REMPLACEZ PAR VOTRE URL (M√™me lien de d√©ploiement)
        const STORAGE_KEY = 'agri_data_v32'; 
        const SETTINGS_KEY = 'agri_settings_v32'; 

        const CROPS_LIST = [
            { id: 'olivier', name: 'Olivier', icon: 'olive' },
            { id: 'amandier', name: 'Amandier', icon: 'almond' },
            { id: 'figuier', name: 'Figuier', icon: 'fig' },
            { id: 'cannabis', name: 'Cannabis', icon: 'flower' },
            { id: 'avoine', name: 'Avoine vert', icon: 'wheat' },
            { id: 'bersim', name: 'Bersim', icon: 'leaf' },
            { id: 'feverole', name: 'F√©verole', icon: 'bean' },
            { id: 'luzerne', name: 'Luzerne', icon: 'leaf' },
            { id: 'mais', name: 'Mais fourrager', icon: 'corn' },
            { id: 'melange', name: 'M√©lange fourrager', icon: 'wheat' },
            { id: 'orge', name: 'Orge fourrager', icon: 'wheat' },
            { id: 'ail', name: 'Ail', icon: 'garlic' },
            { id: 'aubergine', name: 'Aubergine', icon: 'eggplant' },
            { id: 'carotte', name: 'Carotte', icon: 'carrot' },
            { id: 'choux_fleur', name: 'Choux fleur', icon: 'broccoli' },
            { id: 'choux_pomme', name: 'Choux pomme', icon: 'cabbage' },
            { id: 'courge', name: 'Courge courgette', icon: 'squash' },
            { id: 'feve_verte', name: 'F√®ve verte', icon: 'bean' },
            { id: 'melon', name: 'Melon', icon: 'melon' },
            { id: 'navet', name: 'Navet', icon: 'turnip' },
            { id: 'oignon', name: 'Oignon', icon: 'onion' },
            { id: 'pasteque', name: 'Past√®que', icon: 'watermelon' },
            { id: 'petit_pois', name: 'Petit Pois vert', icon: 'pea' },
            { id: 'piment', name: 'Piment poivron', icon: 'pepper' },
            { id: 'pomme_terre', name: 'Pomme de terre', icon: 'potato' },
            { id: 'tomate', name: 'Tomate', icon: 'tomato' },
            { id: 'ble_dur', name: 'BLE DUR', icon: 'wheat' },
            { id: 'ble_tendre', name: 'BLE TENDRE', icon: 'wheat' },
            { id: 'mais_grain', name: 'Mais', icon: 'corn' },
            { id: 'orge_grain', name: 'ORGE', icon: 'wheat' },
            { id: 'feve_sec', name: 'F√®ve', icon: 'bean' },
            { id: 'lentille', name: 'Lentille', icon: 'lentil' },
            { id: 'pois_chiche', name: 'Pois chiche', icon: 'chickpea' }
        ];

        // --- SERVICES (Identique) ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.4); 
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const getStoredRecords = () => {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } 
            catch { return []; }
        };

        const getSettings = () => {
            try { 
                const s = JSON.parse(localStorage.getItem(SETTINGS_KEY));
                return { collectorName: s?.collectorName || '', googleScriptUrl: NEW_SCRIPT_URL };
            } catch { 
                return { collectorName: '', googleScriptUrl: NEW_SCRIPT_URL }; 
            }
        };

        const saveSettings = (s) => localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));

        const syncToGoogleSheets = async (record, url) => {
            try {
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(record)
                });
                return true;
            } catch (e) {
                console.error("Sync Error:", e);
                return false;
            }
        };

        const formatDateFR = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        };

        // --- COMPOSANTS (Identique) ---
        const RenderIcon = ({ iconName, className }) => {
            const props = { className };
            if (iconName === 'flower') return <Flower2Icon {...props} />;
            if (iconName === 'wheat') return <WheatIcon {...props} />;
            if (iconName === 'leaf') return <LeafIcon {...props} />;
            if (iconName === 'sprout') return <SproutIcon {...props} />;
            if (iconName === 'fig') return <LeafIcon {...props} />;
            
            const emojiMap = {
                'olive': 'ü´í', 'almond': 'üå∞', 'carrot': 'ü•ï', 'corn': 'üåΩ',
                'garlic': 'üßÑ', 'eggplant': 'üçÜ', 'broccoli': 'ü•¶', 'cabbage': 'ü•¨',
                'squash': 'ü•í', 'bean': 'ü´ò', 'melon': 'üçà', 'turnip': 'ü•î',
                'onion': 'üßÖ', 'watermelon': 'üçâ', 'pepper': 'üå∂Ô∏è', 'potato': 'ü•î',
                'tomato': 'üçÖ', 'pea': 'ü´õ', 'lentil': 'ü´ò', 'chickpea': 'ü´ò'
            };

            if (emojiMap[iconName]) return <span className={`text-xl leading-none flex items-center justify-center ${className}`}>{emojiMap[iconName]}</span>;
            return <SproutIcon {...props} />;
        };

        const LocationCard = ({ location, setLocation, area, setArea }) => {
            const handleGetLocation = () => {
                setLocation(prev => ({ ...prev, loading: true, error: null }));
                if (!navigator.geolocation) {
                    setLocation(prev => ({ ...prev, loading: false, error: "GPS non support√©" }));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => setLocation({
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        accuracy: pos.coords.accuracy,
                        loading: false,
                        error: null
                    }),
                    (err) => {
                        let msg = "Erreur GPS";
                        if (err.code === 1) msg = "Autorisation GPS refus√©e.";
                        else if (err.code === 2) msg = "Position indisponible (Sortez dehors).";
                        else if (err.code === 3) msg = "Timeout GPS";
                        setLocation(prev => ({ ...prev, loading: false, error: msg }));
                    },
                    { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                );
            };

            return (
                <div className={`bg-white rounded-2xl shadow-sm border p-5 space-y-4 ${location.error ? 'border-red-200' : 'border-gray-100'}`}>
                    <div className="flex items-center space-x-2 text-agri-700 border-b border-gray-100 pb-2">
                        <MapPinIcon className="w-5 h-5" />
                        <h2 className="text-lg font-bold">Localisation <span className="text-red-500">*</span></h2>
                    </div>
                    
                    <button 
                        onClick={handleGetLocation} 
                        disabled={location.loading}
                        className={`w-full py-3 rounded-xl flex items-center justify-center space-x-2 text-white font-semibold transition-all shadow-md active:scale-95 ${location.loading ? 'bg-gray-400' : location.latitude ? 'bg-green-600' : 'bg-agri-600'}`}
                    >
                        {location.loading ? <RefreshCwIcon className="animate-spin-slow w-5 h-5" /> : 
                         location.latitude ? <CheckCircle2Icon className="w-5 h-5"/> : 
                         <NavigationIcon className="w-5 h-5"/>}
                        <span>{location.loading ? 'Recherche GPS...' : location.latitude ? 'GPS Actualis√©' : 'Obtenir position GPS'}</span>
                    </button>

                    {location.error && (
                        <div className="text-red-600 text-sm bg-red-50 p-3 rounded-lg border border-red-100 flex items-start gap-2">
                            <AlertTriangleIcon className="w-5 h-5 shrink-0" />
                            <span>{location.error}</span>
                        </div>
                    )}

                    {location.latitude && (
                        <div className="grid grid-cols-3 gap-2 text-center text-xs bg-green-50 p-2 rounded border border-green-100">
                            <div><span className="text-gray-500 block font-bold">LAT</span><span className="font-mono font-bold text-green-800">{location.latitude.toFixed(5)}</span></div>
                            <div><span className="text-gray-500 block font-bold">LONG</span><span className="font-mono font-bold text-green-800">{location.longitude.toFixed(5)}</span></div>
                            <div><span className="text-gray-500 block font-bold">PREC</span><span className="font-mono font-bold text-green-800">{Math.round(location.accuracy)}m</span></div>
                        </div>
                    )}

                    <div>
                        <label className="text-sm font-semibold text-agri-800 mb-1 block">Superficie (Ha)</label>
                        <input type="number" step="0.01" placeholder="Ex: 2.5" value={area} onChange={e => setArea(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-agri-500 outline-none" />
                    </div>
                </div>
            );
        };

        const App = () => {
            const [settings, setSettingsState] = useState(getSettings());
            const [showSettings, setShowSettings] = useState(!settings.collectorName); 
            
            const [records, setRecords] = useState(getStoredRecords());
            
            const [collectionDate, setCollectionDate] = useState(new Date().toISOString().split('T')[0]);
            const [location, setLocation] = useState({ latitude: null, longitude: null, accuracy: null, loading: false, error: null });
            const [area, setArea] = useState('');
            const [selectedCrop, setSelectedCrop] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [notes, setNotes] = useState('');
            
            const [photo, setPhoto] = useState(null); 
            const [isCompressing, setIsCompressing] = useState(false); 
            
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [notification, setNotification] = useState(null);
            
            const isSyncingRef = useRef(false);

            useEffect(() => {
                const updateOnline = () => setIsOnline(navigator.onLine);
                window.addEventListener('online', updateOnline);
                window.addEventListener('offline', updateOnline);
                return () => {
                    window.removeEventListener('online', updateOnline);
                    window.removeEventListener('offline', updateOnline);
                };
            }, []);

            // Processus de synchronisation par lot (Identique)
            useEffect(() => {
                const runSync = async () => {
                    if (!navigator.onLine || isSyncingRef.current || !settings.googleScriptUrl) return;
                    
                    isSyncingRef.current = true;
                    
                    let currentRecords = getStoredRecords();
                    let unsynced = currentRecords.filter(r => !r.synced);
                    
                    if (unsynced.length === 0) {
                        isSyncingRef.current = false;
                        return;
                    }

                    let hasNewSyncs = false;
                    let recordsToSend = unsynced;
                    
                    for (let i = 0; i < recordsToSend.length; i++) {
                        const record = recordsToSend[i];
                        if (!navigator.onLine) break; 
                        if (record.synced) continue; 
                        
                        const success = await syncToGoogleSheets(record, settings.googleScriptUrl);
                        
                        if (success) {
                            record.synced = true;
                            hasNewSyncs = true;
                        }
                        await new Promise(resolve => setTimeout(resolve, 500)); 
                    }

                    if (hasNewSyncs) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(currentRecords));
                        setRecords([...currentRecords]); 
                    }
                    
                    isSyncingRef.current = false;
                };
                
                const interval = setInterval(runSync, 10000); 
                runSync(); 

                return () => clearInterval(interval);
            }, [settings.googleScriptUrl]); 

            const filteredCrops = useMemo(() => CROPS_LIST.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase())), [searchTerm]);

            const handlePhotoChange = async (e) => {
                const fileInput = e.target; 
                if (fileInput.files && fileInput.files[0]) {
                    setIsCompressing(true);
                    try {
                        const compressed = await compressImage(fileInput.files[0]);
                        setPhoto(compressed); 
                        showNotif('success', 'Photo captur√©e et compress√©e.');
                    } catch (err) {
                        showNotif('error', 'Erreur de lecture de la photo. R√©essayez.');
                        setPhoto(null);
                    }
                    setIsCompressing(false);
                }
                // Correction Cam√©ra: Efface la valeur de l'input pour √©viter les conflits de cache WebView/Cam√©ra.
                fileInput.value = null; 
            };
            
            const showNotif = (type, msg) => {
                setNotification({ type, message: msg });
                setTimeout(() => setNotification(null), 4000);
            };

            // üéØ M√âTHODE STABLE : Lecture par ID du DOM
            const handleSaveSettings = () => {
                const nameInput = document.getElementById('collectorNameInput');
                const name = nameInput ? nameInput.value : '';

                if (!name || name.trim() === '') {
                    return showNotif('error', 'Le nom du collecteur est obligatoire.');
                }
                const s = { collectorName: name.trim(), googleScriptUrl: NEW_SCRIPT_URL };
                setSettingsState(s);
                saveSettings(s);
                setShowSettings(false);
            };

            const handleSubmit = async () => {
                if (!settings.collectorName) return showNotif('error', 'Nom manquant (Param√®tres)');
                if (!selectedCrop) return showNotif('error', 'Culture manquante !');
                if (!location.latitude) return showNotif('error', 'GPS OBLIGATOIRE !');
                if (isCompressing) return showNotif('error', 'Photo en cours de compression...');

                setIsSubmitting(true);
                
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const timestamp = `${day}/${month}/${year}`;
                
                const formattedCollectionDate = formatDateFR(collectionDate);

                const newRecord = {
                    id: Date.now().toString(), 
                    timestamp: timestamp, 
                    collectorName: settings.collectorName,
                    collectionDate: formattedCollectionDate, 
                    latitude: location.latitude,
                    longitude: location.longitude,
                    accuracy: location.accuracy,
                    area,
                    crop: selectedCrop,
                    notes,
                    photo: photo || '', 
                    synced: false
                };

                const current = getStoredRecords();
                const updated = [newRecord, ...current];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
                setRecords(updated); 
                
                setIsSubmitting(false);
                showNotif('success', 'Enregistr√© ! L\'envoi des donn√©es se fait en arri√®re-plan...');
                
                setArea(''); setSelectedCrop(''); setNotes(''); setPhoto(null); 
                setLocation({ latitude: null, longitude: null, accuracy: null, loading: false, error: null });
            };

            const unsyncedCount = records.filter(r => !r.synced).length;

            if (showSettings) {
                return (
                    <div className="min-h-screen bg-agri-50 p-4 flex flex-col justify-center items-center">
                        <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-md animate-in">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-agri-800">
                                <SettingsIcon className="w-6 h-6"/> Configuration v1
                            </h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">Votre Nom <span className="text-red-500">*</span></label>
                                    <input 
                                        type="text" 
                                        id="collectorNameInput" // ‚¨ÖÔ∏è L'ID utilis√© dans handleSaveSettings
                                        defaultValue={settings.collectorName}
                                        placeholder="Ex: Ahmed" 
                                        className="w-full p-3 border rounded-xl" 
                                    />
                                </div>
                                <button 
                                    onClick={handleSaveSettings} 
                                    className="w-full bg-agri-600 text-white font-bold py-3 rounded-xl shadow-lg mt-2"
                                >
                                    Valider
                                </button>
                                {records.length > 0 && <button onClick={() => setShowSettings(false)} className="w-full text-gray-500 py-2">Annuler</button>}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-10 bg-agri-50 font-sans max-w-md mx-auto shadow-xl relative">
                    <div className="bg-agri-800 text-white pb-6 pt-6 px-4 rounded-b-3xl shadow-lg sticky top-0 z-50">
                        <div className="flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-bold">AgriCollect</h1>
                                <p className="text-xs text-agri-200 opacity-80">Chefchaouen (v1)</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className={`flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-bold ${isOnline ? 'bg-green-400 text-green-900' : 'bg-gray-300 text-gray-800'}`}>
                                    {isOnline ? <WifiIcon className="w-3 h-3"/> : <WifiOffIcon className="w-3 h-3"/>}
                                </div>
                                <button onClick={() => setShowSettings(true)} className="p-2 bg-agri-700 rounded-full hover:bg-agri-600 shadow-md">
                                    <SettingsIcon className="w-4 h-4"/>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="px-4 -mt-4 space-y-5 relative z-10">
                        <div className="bg-white rounded-2xl shadow-sm p-4 border border-gray-100 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-agri-100 p-2 rounded-full text-agri-700"><UserIcon className="w-5 h-5"/></div>
                                <div>
                                    <p className="text-xs text-gray-500">Collecteur</p>
                                    <p className="font-bold text-sm truncate max-w-[120px]">{settings.collectorName}</p>
                                </div>
                            </div>
                            <input type="date" value={collectionDate} onChange={e=>setCollectionDate(e.target.value)} className="bg-gray-50 border rounded-lg p-2 text-sm outline-none" />
                        </div>

                        <LocationCard location={location} setLocation={setLocation} area={area} setArea={setArea} />

                        <div className="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
                            <div className="flex items-center gap-2 text-agri-700 border-b pb-2 mb-3">
                                <SproutIcon className="w-5 h-5"/> <span className="font-bold">Culture <span className="text-red-500">*</span></span>
                            </div>
                            <input type="text" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Chercher..." className="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mb-2 text-sm" />
                            <div className="grid grid-cols-3 gap-2 max-h-48 overflow-y-auto">
                                {filteredCrops.map(c => (
                                    <button key={c.id} onClick={() => setSelectedCrop(c.name)} className={`p-2 rounded-lg border text-xs font-bold flex flex-col items-center transition-all ${selectedCrop === c.name ? 'bg-agri-100 border-agri-600 ring-1 ring-agri-600' : 'bg-white hover:bg-gray-50'}`}>
                                        <div className="text-agri-600 mb-1"><RenderIcon iconName={c.icon} className="w-6 h-6"/></div>
                                        <span className="text-center leading-tight">{c.name}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
                            <div className="flex items-center gap-2 text-agri-700 border-b pb-2 mb-3">
                                <CameraIcon className="w-5 h-5"/> <span className="font-bold">Photo & Notes</span>
                            </div>
                            <div className="flex gap-3">
                                <label className={`flex-shrink-0 w-24 h-24 border-2 border-dashed rounded-xl flex items-center justify-center overflow-hidden cursor-pointer relative active:scale-95 transition-all ${photo ? 'border-agri-600 bg-agri-100' : 'border-gray-300 bg-gray-50 hover:bg-gray-100'}`}>
                                    {isCompressing ? (
                                        <RefreshCwIcon className="animate-spin text-agri-500"/>
                                    ) : photo ? (
                                        <>
                                            <CheckCircle2Icon className="absolute w-8 h-8 text-agri-800 opacity-100 drop-shadow-lg"/>
                                        </>
                                    ) : (
                                        <div className="text-center">
                                            <CameraIcon className="text-gray-400 w-8 h-8 mx-auto"/>
                                            <span className="text-[10px] text-gray-400 font-bold block">PHOTO</span>
                                        </div>
                                    )}
                                    <input type="file" accept="image/*" capture="camera" onChange={handlePhotoChange} className="hidden" /> 
                                </label>
                                
                                <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Notes..." className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm resize-none"></textarea>
                            </div>
                            {photo && <button onClick={() => setPhoto(null)} className="text-xs text-red-500 mt-1 underline">Supprimer photo</button>}
                        </div>

                        <button onClick={handleSubmit} disabled={isSubmitting} className="w-full py-4 bg-agri-700 hover:bg-agri-800 text-white font-bold rounded-2xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all">
                            {isSubmitting ? "Enregistrement..." : <><SendIcon className="w-5 h-5"/> ENREGISTRER</>}
                        </button>

                        <div className="bg-gray-200 p-4 rounded-2xl flex justify-between items-center text-sm">
                            <div className="flex items-center gap-2 text-gray-700">
                                <DatabaseIcon className="w-4 h-4"/>
                                <span className="font-bold">{records.length} relev√©s</span>
                            </div>
                            {unsyncedCount > 0 ? (
                                <div className="flex items-center gap-1 text-orange-700 font-bold bg-orange-100 px-2 py-1 rounded-lg">
                                    <RefreshCwIcon className="w-3 h-3 animate-spin-slow"/> {unsyncedCount} attente
                                </div>
                            ) : (
                                <div className="flex items-center gap-1 text-green-700 font-bold bg-green-100 px-2 py-1 rounded-lg">
                                    <CheckCircle2Icon className="w-3 h-3"/> Tout sync
                                </div>
                            )}
                        </div>
                    </div>

                    {notification && (
                        <div className={`fixed bottom-5 left-4 right-4 p-4 rounded-xl shadow-2xl text-white font-bold text-center z-[100] animate-in ${notification.type==='success'?'bg-agri-900':'bg-red-600'}`}>
                            {notification.message}
                        </div>
                    )}
                </div>
            );
        };
        
    </script>
    
    <script>
        window.onload = function() {
            try {
                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(React.createElement(App, null)); 
            } catch (e) {
                console.error("Erreur critique de montage React:", e);
                document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red; text-align: center;"><h1>√âchec de chargement de l\'application. (V√©rifiez les fichiers lib)</h1></div>';
            }
        };
    </script>

</body>
</html>