present perfect

code gs :

// ⚠️ CRITIQUE: REMPLACEZ CETTE CHAÎNE PAR L'ID EXACT DE VOTRE DOSSIER GOOGLE DRIVE
const DRIVE_FOLDER_ID = '1QrnPK4Y3B5YWqpa2zyopf5IpuhXa-cjJ'; // REMPLACEZ CETTE VALEUR

const SHEET_NAME = "Donnees"; 
const HEADERS = ['Timestamp', 'NomCollecteur', 'DateCollecte', 'Culture', 'SuperficieHa', 'Latitude', 'Longitude', 'PrecisionM', 'LienPhoto', 'Notes', 'ID'];

function createResponse(data, status = 200) {
    const output = ContentService.createTextOutput(JSON.stringify(data));
    output.setStatusCode(status);
    output.setMimeType(ContentService.MimeType.JSON);
    output.append("Access-Control-Allow-Origin", "*"); 
    return output;
}

function checkAndSetHeaders(sheet) {
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(HEADERS);
    Logger.log("Entêtes créées automatiquement: " + HEADERS.join(', '));
  }
}

function doPost(e) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000); 

    if (!e.postData) {
      return createResponse({ success: false, error: "Pas de données reçues." }, 400);
    }
    
    var data = JSON.parse(e.postData.contents);
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(SHEET_NAME); 
    
    if (!sheet) {
        return createResponse({ success: false, error: "Onglet '" + SHEET_NAME + "' introuvable." }, 500);
    }
    
    checkAndSetHeaders(sheet);

    // --- TRAITEMENT DE LA PHOTO ---
    var photoUrl = "";
    const driveIdConfigured = (DRIVE_FOLDER_ID && DRIVE_FOLDER_ID !== 'votre_longue_chaine_id_ici'); // Vérification mise à jour

    if (data.photo && driveIdConfigured) {
      try {
        var base64Data = data.photo.split(',')[1]; 
        var blob = Utilities.newBlob(Utilities.base64Decode(base64Data), 'image/jpeg', data.id + '_photo.jpg');
        
        var folder = DriveApp.getFolderById(DRIVE_FOLDER_ID); 
        var file = folder.createFile(blob);
        
        photoUrl = file.getUrl(); 
      } catch (photoErr) {
        // En cas d'erreur Drive, le lien contiendra l'erreur pour la détection
        photoUrl = "Erreur Drive: " + photoErr.message + " (Vérifiez l'ID et les autorisations)";
      }
    } else if (data.photo && !driveIdConfigured) {
        photoUrl = "ERREUR: ID de dossier Drive manquant (Veuillez configurer Code.gs).";
    }

    // --- INSERTION DE LA LIGNE ---
    sheet.appendRow([
        data.timestamp,
        data.collectorName,
        data.collectionDate,
        data.crop,
        data.area,
        data.latitude,
        data.longitude,
        data.accuracy,
        photoUrl, // LienPhoto
        data.notes,
        data.id
    ]);

    return createResponse({ success: true, id: data.id });

  } catch (err) {
    Logger.log("Erreur fatale de script : " + err.toString());
    return createResponse({ success: false, error: err.message }, 500);
  } finally {
    lock.releaseLock();
  }
}

function doGet(e) {
  return HtmlService.createHtmlOutput("Méthode GET non supportée.");
}








appsscript.json

{
  "timeZone": "Europe/Paris",
  "dependencies": {},
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/script.external_request"
  ],
  "webapp": {
    "executeAs": "USER_DEPLOYING",
    "access": "ANYONE_ANONYMOUS"
  }
}